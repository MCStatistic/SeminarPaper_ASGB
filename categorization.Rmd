---
title: "categorization"
author: "Marlon Schumacher"
date: "24 1 2019"
output: html_document
---

```{r}
library(pacman)
p_load(dplyr, haven, readr, ggplot2, pdftools, stringr, lubridate, RColorBrewer, tm, ggthemes)
```


```{r}
load("df_complete_clean.RData")

# removing numbers and punctuation
df_complete_clean$title %<>% 
  removeNumbers() %>% 
  removePunctuation()

# does work
head(grepl("polizei", df_complete_clean$title))

head(grepl(("polizei|sicherheit"), df_complete_clean$title))

df_complete_clean$title
  
head(df_complete_clean)

# deleting all files with no title (15 rows only)
df_complete_clean %<>% 
  filter(!is.na(title))

```

## matching with str_detect
```{r}
# matching words for each category

# topic 1
makroöko <- c("arbeitslosigkeit", "arbeitslosenquote", "zinsen","haushaltsschulden",
              "steuer","industrie") %>% 
  paste0(collapse = "|")

# topic 2
buerger <- c("diskriminierung", "minderheit", "meinungsfreiheit", "religionsfreiheit", 
             "partizipation", "wahlrecht", "gender", "gleichberechtigung", "gleichstellung",
             "gleichgeschlechtliche ehen", "öffentlichkeitsbeteiligung") %>% 
  paste0(collapse = "|")

# topic 3
gesundheit <- c("pflege", "pflegeversicherung", "krankenversicherung", "krankenkasse",
                "arzt", "krankheit","impfquote", "impfung", "alkoholkonsum", "arzneimittel",
                "gesundheitsschutz", "medizin", "patienten") %>% 
  paste0(collapse = "|")

# topic 4
agrar <- c("agrar", "landwirtschaft", "landwirte", "pflanzenschutzmittel","glyphosat") %>% 
  paste0(collapse = "|")

# topic 5
arbeit <- c("gewerkschaft", "elternzeit", "kinderbetreuung", "saisonarbeit", "arbeitsschutz", 
            "arbeitssicherheit", "mindestlohn", "mindestlöhne", "streik", "überstunden",
            "arbeitszeitgesetz", "fachkräftemangel", "arbeitszeit", "geringfügige beschäftigung",
            "befristete beschäftigung", "arbeitsbedingungen", "befristeter beschäftigung",
            "leiharbeit", "arbeit auf abruf", "arbeitsunfälle", "stellenabbau",
            "niedriglöhne") %>% 
  paste0(collapse = "|")

# topic 6
bildung <- c("studium", "lehrer", "schule", "universität", "weiterbildung",
             "geisteswissenschaften", "hochschul") %>% 
  paste0(collapse = "|")

# topic 7 
umwelt <- c("trinkwasser", "recycling", "müll", "luftverschmutzung", "plastik",
            "klimawandel", "emission", "artenschutz", "stickoxide", "wasserqualität", "umwelt",
            "klimaschutz", "insekten", "co2-speicherung", "grundwasser", "tierschutz",
            "atomtransport", "ökologisch") %>% 
  paste0(collapse = "|")

# topic 8
energie <- c("kohle", "kohleausstieg", "energie", "atomkraft", "solar", "windenergie", "erneuerbare",
             "atomstandort") %>% 
  paste0(collapse = "|")

# topic 9
einwanderung <- c("flüchtlinge", "asyl", "migration", "einwanderer", "einwanderung", 
                  "abschiebung", "integration", "familiennachzug", "schutzsuchende",
                  "fluchtursachen", "duldung", "zuwanderung") %>% 
  paste0(collapse = "|")

# topic 10
transport <- c("autobahn", "schienenverkehr", "bahn", "flughafen", "lkw", "maut", "mobilität", 
               "schienen", "zugverspätung", "verkehrswende", "verkehrsprojekt", "radverkehr",
               "verkehrspolitik", "straßenbrücke", "verkehrsminister") %>% 
  paste0(collapse = "|")

# topic 11
krimi <- c("rauschmittel", "steuerhinterziehung", "bnd", "bundesnachrichtendienst", 
           "gefängnis", "kindesmissbrauch", "kinderpornografie", "interpol", 
           "kindesentführung", "straftaten", "kriminalität", "sicherungsverwahrung",
           "tötungsdelikte", "haftbefehl", "bundeskriminalamt", "polizei", "gewalttaten",
           "linksextrem", "rechtsextrem", "ermittlungsverfahren", "gefährder") %>% 
  paste0(collapse = "|")

# topic 12
sozi <- c("arbeitslosengeld", "renten", "altersarmut", "pension", "armut", "tafel", "kindergeld",
          "jobcenter", "sgb-ii", " rente ", "vermögensungleichheit", "einkommensungleichheit",
          "riester-rente", "sozialgesetzbuch", "altersvorsorge") %>% 
  paste0(collapse = "|")

# topic 13
wohn <- c("mietpreis", "miete", "wohnung", "obdachlos", "wohnhilfe", "wohnheim",
          "brachfläche", "wohnen") %>% 
  paste0(collapse = "|")

# topic 14
banken <- c("bank", "kartell", "finanzsektor", "verbraucherschutz", "tourismus", "patent", "urheberrecht",
            "verbraucherschutz", "verbraucherrecht", "fluthilfe", "wettbewerbsbeschränkung", "katastrophenschutz",
            "finanzmarkt", "kapitalmarkt") %>% 
  paste0(collapse = "|")

# topic 15
verteidigung <- c("bundeswehr", "kriegseinsatz", "kriegseinsätze", "nato") %>% 
  paste0(collapse = "|")

# topic 16
tech_kom <- c("internet", "breitband", "telekommunikation", "gez", "rundfunk", "twitter", "facebook",
              "digitalisierung", "raumfahrt", "cybersicherheit") %>% 
  paste0(collapse = "|")

# topic 17
außenh <- c("handelsabkommen", "export", "import", "zölle", "einfuhrbeschränkung", 
            "einfuhr", "steueroasen", "freihandel", "außenhandel", "export", "waffenexport",
            "ceta", "ttip", "transatlantic trade") %>% 
  paste0(collapse = "|")

# topic 18
int_aus <- c("auslandshilfe", "entwicklungsländer", "menschenrecht", "humanitäre hilfe", "brexit",
             "arbeitsbedingungen in schwellen und entwicklu", "islamischer staat", "terror",
             "bürgerkrieg") %>% 
  paste0(collapse = "|")

regierung <- c(" sanktionen ", "bürokratieentlastung", "bürokratieabbau", 
               "bundesanstalt für immobilienaufgaben", "deutsch-georgische", "deutsch-türkischen",
               "deutsch-indischen", "deutsch-montenegrinische", "deutsch-russische",
               "deutsch-armenische", "deutsch-ukrainische", "deutschland und aserbaidschan",
               "diplomat") %>% 
  paste0(collapse = "|")

# public goods muss raus, da es hierzu nahezu keinerlei Themen gibt
public_goods <- c("denkmal", "denkmäler") %>% 
  paste0(collapse = "|")

df_complete_clean %<>% 
  mutate(thema = case_when(
    str_detect(title, makroöko) ~ "Makroökonomie", #1
    str_detect(title, buerger) ~ "Bürgerrechte",#2
    str_detect(title, gesundheit) ~ "Gesundheit", #3
    str_detect(title, agrar) ~ "Agrarwirtschaft", #4
    str_detect(title, arbeit) ~ "Arbeit & Beschäftigung", #5
    str_detect(title, bildung) ~ "Bildung", #6
    str_detect(title, umwelt) ~ "Umwelt", #7
    str_detect(title, energie) ~ "Energie", #8
    str_detect(title, einwanderung) ~ "Einwanderung", #9
    str_detect(title, transport) ~ "Transport", #10
    str_detect(title, krimi) ~ "Kriminalität & Familienprobleme", #11
    str_detect(title, sozi) ~ "Soziale Wohlfahrt", #12
    str_detect(title, wohn) ~ "Gemeindeentwicklung & Wohnungsprobleme", #13
    str_detect(title, banken) ~ "Banken, Finanzen & Binnenhandel", #14
    str_detect(title, verteidigung) ~ "Verteidigung", #15
    str_detect(title, tech_kom) ~ "Technologie & Kommunikation", #16
    str_detect(title, außenh) ~ "Außenhandel", #17
    str_detect(title, int_aus) ~ "Internationale Angelegenheiten & Auslandshilfe", #18
    str_detect(title, regierung) ~ "Regierungsoperationen", #19
    # str_detect(title, public_goods) ~ "Öffentliche Flächen", #20
    TRUE ~ "zSonstiges"
  ))

df_complete_clean %>% 
  sjmisc::frq(thema) %>% 
  kableExtra::kable()

df_complete_clean %>% 
  filter(str_detect(title, "diplomat") == TRUE)


View(df_complete_clean %>% 
       select(title, thema, file) %>% 
       filter(thema == "zSonstiges"))
```

## checking categories if the fitting is good
```{r}
# looks very good
View(df_complete_clean %>% 
  select(title, thema) %>% 
  filter(thema == "Soziale Wohlfahrt"))

View(df_complete_clean %>% 
  select(title, thema) %>% 
  filter(thema == "Gemeindeentwicklung & Wohnungsprobleme"))

View(df_complete_clean %>% 
  select(title, thema) %>% 
  filter(thema == "Transport"))
```

## checking overlapping
```{r}
df_overlap <- df_complete_clean %>% 
  mutate(makroökonomie = case_when(str_detect(title, makroöko) ~ 1, TRUE ~ 0)) %>% 
  mutate(buerger = case_when(str_detect(title, buerger) ~ 1, TRUE ~ 0)) %>% 
  mutate(gesundheit = case_when(str_detect(title, gesundheit) ~ 1, TRUE ~ 0)) %>% 
  mutate(agrar = case_when(str_detect(title, agrar) ~ 1, TRUE ~ 0)) %>% 
  mutate(arbeit = case_when(str_detect(title, arbeit) ~ 1, TRUE ~ 0)) %>% 
  mutate(bildung = case_when(str_detect(title, bildung) ~ 1, TRUE ~ 0)) %>% 
  mutate(umwelt = case_when(str_detect(title, umwelt) ~ 1, TRUE ~ 0)) %>% 
  mutate(energie = case_when(str_detect(title, energie) ~ 1, TRUE ~ 0)) %>% 
  mutate(einwanderung = case_when(str_detect(title, einwanderung) ~ 1, TRUE ~ 0)) %>% 
  mutate(transport = case_when(str_detect(title, transport) ~ 1, TRUE ~ 0)) %>% 
  mutate(krimi = case_when(str_detect(title, krimi) ~ 1, TRUE ~ 0)) %>% 
  mutate(sozi = case_when(str_detect(title, sozi) ~ 1, TRUE ~ 0)) %>% 
  mutate(wohn = case_when(str_detect(title, wohn) ~ 1, TRUE ~ 0)) %>% 
  mutate(banken = case_when(str_detect(title, banken) ~ 1, TRUE ~ 0)) %>% 
  mutate(verteidigung = case_when(str_detect(title, verteidigung) ~ 1, TRUE ~ 0)) %>% 
  mutate(tech_kom = case_when(str_detect(title, tech_kom) ~ 1, TRUE ~ 0)) %>% 
  mutate(außenh = case_when(str_detect(title, außenh) ~ 1, TRUE ~ 0)) %>% 
  mutate(int_aus = case_when(str_detect(title, int_aus) ~ 1, TRUE ~ 0)) %>%
  mutate(regierung = case_when(str_detect(title, regierung) ~ 1, TRUE ~ 0)) %>% 
  mutate(public_good = case_when(str_detect(title, public_goods) ~ 1, TRUE ~ 0)) %>% 
  mutate(overlap = makroökonomie + buerger + gesundheit + agrar +
                       arbeit + bildung + umwelt + energie + einwanderung +
                       transport + krimi + sozi + wohn + banken + verteidigung +
                       tech_kom + außenh + int_aus + regierung + public_good)


df_overlap %>% 
  filter(overlap != 0) %>% 
  sjmisc::frq(overlap)

View(df_overlap %>%
  select(overlap, title, thema, file) %>% 
  filter(overlap == 2))

View(df_overlap %>%
  filter(overlap == 4))

```

# Falsches Matching korrigieren
```{r}
# für alle matches mit 3 overlaps
View(df_overlap %>%
       select(overlap, title, thema, file) %>%
       filter(overlap == 3))

df_complete_clean <- df_complete_clean %>% 
  mutate(thema = case_when(
    # wenn file == xy, dann soll x-thema zugewiesen werden
    file == "1900907" ~ "Internationale Angelegenheiten & Auslandshilfe", # terror
    file == "1903371" ~ "Außenhandel", # Waffenexporte
    file == "1902085" ~ "zSonstiges", # viel zu unspezifisch!
    file == "1800584" ~ "Außenhandel", # Handelsabkommen...
    file == "1808522" ~ "Internationale Angelegenheiten & Auslandshilfe", # steueroasen (int. Finanzm.)
    file == "1811759" ~ "Internationale Angelegenheiten & Auslandshilfe", # terror
    file == "1813162" ~ "Außenhandel", # handelsabkommen
    TRUE ~ thema)) # alle restlichen anfragen erhalten die bereits zugeordnete themen

right_matches_3 <- c("1800521")

# alle anfragen mit overlap von 2
View(df_overlap %>%
  select(overlap, title, thema, file) %>% 
  filter(overlap == 2))

df_complete_clean <- df_complete_clean %>% 
  mutate(thema = case_when(
    # wenn file == xy, dann soll x-thema zugewiesen werden
    file == "1901063" ~ "Energie", #primäres Energiethema
    file == "1802295" ~ "Außenhandel", #Wirtschaftsfolgen von Subventionen in der Landwirtschaft
    file == "1808135" ~ "Außenhandel", # Zollabbau im Zuge von ttip
    file == "1808485" ~ "Umwelt", # Klimaschutz in der Landwirtschaft
    file == "1803623" ~ "Kriminalität & Familienprobleme", #Arbeitsbedingungen für polizisten im Ausland
    file == "1805772" ~ "Internationale Angelegenheiten & Auslandshilfe", # Einfluss von d. Markt auf                                                                                    Entwicklungsländer
    file == "1808498" ~ "Soziale Wohlfahrt", #höhe von Mindestlohn zur Bekämpfung von Armut
    file == "1806954" ~ "Verteidigung", # Bundeswehrfragen
    file == "1901953" ~ "Technologie & Kommunikation", #Netzausbau
    file == "1902213" ~ "Einwanderung", #Bildungsförderung von Einwanderern
    file == "1800031" ~ "Verteidigung", # Werbung von Bundeswehr an Schulen
    file == "1800032" ~ "Verteidigung", # Ausmaß von Werbung der Bundesweh an Schulen
    file == "1801088" ~ "Verteidigung", #Bundeswehr und Schule (keine zusätzlichen Infos)
    file == "1902627" ~ "Umwelt", #Mikroplastik 
    file == "1801037" ~ "Kriminalität & Familienprobleme", #deutsch amerikanische zusammenarbeit vs Crime
    file == "1810683" ~ "Kriminalität & Familienprobleme", # irgendwas mit ppolizei
    file == "1900195" ~ "Internationale Angelegenheiten & Auslandshilfe", #Terrorismusprävention bei                                                                                   Flüchtlingen
    file == "1900564" ~ "Kriminalität & Familienprobleme", #Nutzung von interpol vs. Terrorismus 
    file == "1900606" ~ "Kriminalität & Familienprobleme", #Öffnung der Polizei gegenüber Migranten
    file == "1900783" ~ "Internationale Angelegenheiten & Auslandshilfe", #Nachklapp zu 1900195
    file == "1903675" ~ "Kriminalität & Familienprobleme", #Kriminalität von Migranten
    file == "1903824" ~ "Verteidigung", #Natoübung 
    file == "1903994" ~ "Soziale Wohlfahrt", #Renteneinstieg von Flüchtlingen 
    file == "1904307" ~ "Internationale Angelegenheiten & Auslandshilfe", # Bericht über Abschiebungen in                                                                              Madrid
    file == "1906230" ~ "Kriminalität & Familienprobleme", #Statistiken über Kriminalität von Flüchtlingen
    file == "1806872" ~ "Soziale Wohlfahrt", #Altersarmut von jüdischen Einwanderern aus der UdSSR
    file == "1811197" ~ "Verteidigung", #Bundeswehreinsatz im Libanon
    file == "1813196" ~ "Regierungsoperationen", #Kommentar zu Tschetschenien
    file == "1902876" ~ "Kriminalität & Familienprobleme", #Waffenkontrolle
    file == "1903998" ~ "Regierungsoperationen", #Twitternutzung von Regierungsmitgliedern
    file == "1904174" ~ "Gemeindeentwicklung & Wohnungsprobleme", # Wohnungspolitik
    file == "1904417" ~ "Internationale Angelegenheiten & Auslandshilfe", #Brexitfolgen
    file == "1906346" ~ "Makroökonomie", #Rundertisch zu Steuerpolitik
    file == "1900274" ~ "Transport", #Schienenpflege
    file == "1900690" ~ "Einwanderung", #Altersfeststellung von Flüchtlingen
    file == "1903065" ~ "Umwelt", #Umweltfolgen von Amalgamnutzung
    file == "1903084" ~ "Technologie & Kommunikation", #Internet in Altersheimen
    file == "1903961" ~ "Gemeindeentwicklung & Wohnungsprobleme", #eig öffentliche Flächen
    file == "1904271" ~ "Einwanderung", #Abschiebungsverzögerung durch Krankheit
    file == "1904363" ~ "Soziale Wohlfahrt", #Verschuldung durch Krankenversicherung
    file == "1806739" ~ "Transport", # Schienenpflege
    file == "1800078" ~ "Verteidigung", #Rauschmittel bei Auslandseinsätzen der Bundeswehr
    file == "1809998" ~ "Verteidigung", #Rauschmitte bei Auslandseinsätzen der Bundeswehr
    file == "1901782" ~ "Außenhandel", #Rentensteuer von Portugal
    file == "1902279" ~ "Außenhandel", #Steuerfolgen von Brexit
    file == "1905973" ~ "Regierungsoperationen", #Einflussnahme von Lobbyisten
    file == "1906354" ~ "Regierungsoperationen", #Einflussnahme von Lobbyisten
    file == "1801004" ~ "Bürgerrechte", #Steuerliche Gleichstellung von Homoehen
    file == "1804029" ~ "Regierungsoperationen", #Fischerei in Südostasien
    file == "1806230" ~ "Kriminalität & Familienprobleme", #Steuerhinterziehung
    file == "1809904" ~ "Arbeit & Beschäftigung", #Arbeitsbedingungen in der Fleischindustrie
    file == "1813367" ~ "Regierungsoperationen", #Wissenstand der Regierung über Kartellbildung
    file == "1805719" ~ "Verteidigung", #Werbung von Bundeswehr
    file == "1901455" ~ "Kriminalität & Familienprobleme", #Crime at trainstation
    file == "1901589" ~ "Kriminalität & Familienprobleme", #Crime at trainstation
    file == "1901937" ~ "Kriminalität & Familienprobleme", #Crime at trainstation
    file == "1901976" ~ "Kriminalität & Familienprobleme", #Crime in trains
    file == "1902289" ~ "Technologie & Kommunikation", #Internet in der Bahn
    file == "1903499" ~ "Kriminalität & Familienprobleme", #Crime in trains
    file == "1905695" ~ "Technologie & Kommunikation", #Internet in der Bahn
    file == "1809376" ~ "Verteidigung", # Flugshows der Bundeswehr
    file == "1812190" ~ "Kriminalität & Familienprobleme", #Crime at trainstation
    file == "1813229" ~ "Kriminalität & Familienprobleme", #Crime at trainstation
    file == "1807315" ~ "Banken, Finanzen & Binnenhandel", #Tourismusfolgen aus Klimawandel
    TRUE ~ thema)) # alle restlichen anfragen erhalten die bereits zugeordnete themen
  
# richtige Matches, jedoch dennoch vorhandener overlap
right_matches_2 <- c("file1", "file2", "file3")

```

# changing labels
```{r}
df_complete_clean %<>% 
  mutate(thema = case_when(
    thema == "Arbeit & Beschäftigung" ~ "Arbeit",
    thema == "Kriminalität & Familienprobleme" ~ "Gesetz & Kriminalität",
    thema == "Gemeindeentwicklung & Wohnungsprobleme" ~ "Wohnungsbau", 
    thema == "Banken, Finanzen & Binnenhandel" ~ "Binnenhandel", 
    thema == "Technologie & Kommunikation" ~ "Technologie", 
    thema == "Internationale Angelegenheiten & Auslandshilfe" ~ "Int. Angelegenheiten",
    thema == "Internationale Angelegenheiten" ~ "Int. Angelegenheiten",
    # str_detect(title, public_goods) ~ "Öffentliche Flächen", #20
    TRUE ~ thema
  ))
```

# ggpreview
```{r}
# thanks to andrewheiss
ggpreview <- function(..., device = "png", cairo = FALSE) {
fname <- tempfile(fileext = paste0(".", device))
if (cairo & device == "pdf") {
ggplot2::ggsave(filename = fname, device = cairo_pdf, ...)
  } else if (cairo & device == "png") {
ggplot2::ggsave(filename = fname, device = device, type = "cairo", ...)
  } else {
ggplot2::ggsave(filename = fname, device = device, ...)
  }
  system2("open", fname)
invisible(NULL)
}
```


# little inspection
```{r}
# library(ggpubr)
# figure_1 <- ggarrange(plot_18_pre, plot_19_pre,
#           labels = c("18. Bundestag", "19. Bundestag"),
#           ncol = 1, nrow = 2)
# ggsave("figure_1.png", figure_1, width = 10, height = 8)
# 
# ggpreview(figure_1, width = 10, height = 8)

# testing facet_grid() again
# creating labels
labs <- c("18. Bundestag", "19. Bundestag")
levels(df_complete_clean$bt) <- rev(labs)
df_complete_clean$bt_f <- factor(df_complete_clean$bt, labels = c("18. Bundestag", "19. Bundestag"))

# with percentage labels on the y-axis, yay
themen_gesamt_bt <- df_complete_clean %>%
  filter(thema != "zSonstiges") %>%
  group_by(bt_f, thema) %>%
  summarise(n = n()) %>%
  mutate(perc = (n/sum(n))) %>%
  ggplot(aes(x = reorder(thema, +perc), y = perc)) +
  geom_bar(position = "dodge", 
           stat = "identity",
           fill = "skyblue4") +
  facet_wrap(~bt_f, labeller = label_value) +
  geom_text(aes(y = perc, 
                label = sprintf("%1.1f%%", round(100*perc, 1))),
            size = 3.1,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) +
  #ylim(0,0.22)
  theme_bw() +
  ggtitle("") +
  ylab("") +
  xlab("") +
  theme(text=element_text(size = 12)) +
  scale_y_continuous(labels = scales::percent_format(), limits=c(0,0.23)) +
  coord_flip()
  
ggpreview(themen_gesamt_bt, width = 8, height = 6)
ggsave("figure_1.png", figure_1, width = 10, height = 8)

```


# supervised machine
```{r}
install.packages("RTextTools")
library(RTextTools)

df_training <- df_complete_clean %>% 
  filter(thema != "zSonstiges") %>% 
  sample_n(2978)

# nrow(df_training)

# creating df with topic and content
x <- data.frame(thema = df_training$thema , content = df_training$content)
#alle Labels anzeigen
unique(x$thema)

# Erstellung einer VectorSource
source <- VectorSource(x$content)

# corpus erstellen
corpus <- Corpus(source)

# zufallsverteilung funktioniert
# corpus[[1]]$content

corpus <- tm_map(corpus, stripWhitespace)

# creating a documenttermmatrix
mat <- DocumentTermMatrix(corpus)

# train size: 80% = 2978*0.8 = 2383
container <- create_container(mat, x$thema, 
                              trainSize=1:2383,
                              testSize=2384:2978, 
                              virgin=FALSE)

model <- train_model(algorithm = "SVM", 
                     container,
                     kernel='linear')

#das Model wird auf die übrigen 20% angewendet und in results gespeichert.
results <- classify_model(container, model)

tabelle_accuracy<-table(as.character(x$thema[2384:2978]), as.character(results[,"SVM_LABEL"]))
tabelle_accuracy

recall_accuracy(x$thema[2384:2978], results[,"SVM_LABEL"])

test_tibble<-df_training[2384:2978,]
test_tibble$thema_test<-results$SVM_LABEL
test_tibble$prob<-results$SVM_PROB

length(which(test_tibble$thema==test_tibble$thema_test))/length(test_tibble$thema)
#ohne filter 0.687, N= 595

ggplot(test_tibble, aes(prob))+
  geom_histogram()+
  geom_vline(xintercept=mean(test_tibble$prob, na.rm = T), color="red")+
  geom_vline(xintercept = median(test_tibble$prob, na.rm = T), color = "blue")+
  geom_vline(xintercept = 0.6, color = "black")
```

# again but a bit better
```{r}
df_training$thema_f <- factor(df_training$thema)
df_training %<>% 
  mutate(thema_t1 = case_when(
    thema == "Energie" ~ "Energie & Umwelt",
    thema == "Umwelt" ~ "Energie & Umwelt",
    TRUE ~ thema
  ))

df_training_t2 <- df_training %>% 
  filter(thema != "Wohnungsbau" & thema != "Regierungsoperationen")

nrow(df_training_t2)

doc_matrix <- create_matrix(df_training$content)
doc_matrix_t2 <- create_matrix(df_training_t2$content)
container <- create_container(doc_matrix, 
                              df_training$thema, 
                              trainSize=1:2383,
                              testSize=2384:2978, 
                              virgin=FALSE)

container_f <- create_container(doc_matrix, 
                              as.numeric(df_training$thema_f), 
                              trainSize=1:2383,
                              testSize=2384:2978, 
                              virgin=FALSE)

svm_f <- train_model(container_f,"SVM", kernel = "linear")
svm_classify_f <- classify_model(container_f, svm_f)

# creating df with real topics, predicted topic and probability
test_svm_f <- df_training[2384:2978,]
test_svm_f$thema_test <- svm_classify_f$SVM_LABEL
test_svm_f$prob <- svm_classify_f$SVM_PROB

length(which(test_svm_f$thema==test_svm_f$thema_test))/length(test_svm_f$thema)

RTextTools::create_analytics(container_f, svm_classify_f)

# schlechter
container_t1 <- create_container(doc_matrix, 
                                 df_training$thema_t1, 
                                 trainSize=1:2383,
                                 testSize=2384:2978, 
                                 virgin=FALSE)

# schlechter
container_t2 <- create_container(doc_matrix_t2, 
                                 df_training_t2$thema, 
                                 trainSize=1:2383,
                                 testSize=2350:2904, 
                                 virgin=FALSE)

# SVM Algortihm
SVM <- train_model(container,"SVM")
svm_classify <- classify_model(container, SVM)

# creating df with real topics, predicted topic and probability
test_svm <- df_training[2384:2978,]
test_svm$thema_test <- svm_classify$SVM_LABEL
test_svm$prob <- svm_classify$SVM_PROB

length(which(test_svm$thema==test_svm$thema_test))/length(test_svm$thema)
#ohne filter 0.687 (1), 0.744 (2), N= 595

# looking for probabilities
test_svm_04<- test_svm %>%
  filter(prob >= 0.4)%>%
  arrange((prob))
length(which(test_svm_04$thema==test_svm_04$thema_test))/length(test_svm_04$thema)
# 81.9; n = 420 -> 70.6%

test_svm_05 <- test_svm %>%
  filter(prob >= 0.5)%>%
  arrange((prob))
length(which(test_svm_05$thema==test_svm_05$thema_test))/length(test_svm_05$thema)
# 86.2; n = 364 -> 61.2% (von 595)

test_svm_06<- test_svm %>%
  filter(prob >= 0.6)%>%
  arrange((prob))
length(which(test_svm_06$thema==test_svm_06$thema_test))/length(test_svm_06$thema)
nrow(test_svm_06)
# 90.3; n = 310 -> 52% (von 595)
# 2. durchlauf: 0.912; n = 307 -> 52%...


test_svm_07<- test_svm %>%
  filter(prob >= 0.7)%>%
  arrange((prob))
length(which(test_svm_07$thema==test_svm_07$thema_test))/length(test_svm_07$thema)
# 92.7%; n = 263 -> 44% (von 595)


test_svm_08<- test_svm %>%
  filter(prob >= 0.8)%>%
  arrange((prob))
length(which(test_svm_08$thema==test_svm_08$thema_test))/length(test_svm_08$thema)
# 94.1%; n = 190 -> 31.9% (von 595)

test_svm_085<- test_tibble%>%
  filter(prob>=0.85)%>%
  arrange((prob))
length(which(test_svm_085$thema==test_svm_085$thema_test))/length(test_svm_085$thema)
# 95.7%; n = 186 -> 31.2% (von 595)


test_svm_09 <- test_svm %>%
  filter(prob >= 0.9)%>%
  arrange((prob))
length(which(test_svm_09$thema==test_svm_09$thema_test))/length(test_svm_09$thema)
# 98,6% n = 146 -> 24,5% (von 595)


RTextTools::create_analytics(container_f, svm_classify_f)
levels(df_training$thema_f)

svm_classify_f$SVM_PROB

test_svm_f %>% 
  select(thema_test, prob, thema_f, thema) %>% 
  group_by(thema_f) %>% 
  summarise(prob_m = mean(prob), n = n()) %>% 
  arrange(desc(prob_m)) %>% 
  ggplot(aes(x = n, y = prob_m)) +
  geom_bar(position = "dodge",
           stat = "identity") +
  geom_smooth()+
  theme_bw()

```

```{r}
ggplot(df_complete_clean, aes(thema)) +
  geom_bar(position="dodge")

df_complete_clean %>%
  filter(thema != "zSonstiges") %>%
  group_by(party, thema) %>%
  filter(party != "SPD" & party != "Union" & party != "NA") %>% 
  summarise(n = n()) %>%
  mutate(perc = (n/sum(n))) %>%
  mutate(thema = fct_reorder2(thema, party, perc)) %>% 
  ggplot(aes(x = thema, y = perc)) +
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "skyblue4") +
  facet_wrap(~party, labeller = label_value) +
  geom_text(aes(y = perc, 
                label = sprintf("%1.1f%%", round(100*perc, 1))),
            size = 3.1,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) +
  #ylim(0,0.22)
  theme_bw() +
  theme(text=element_text(size = 12)) +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip()

unique(df_complete_clean$party)


df_complete_clean %>%
  filter(thema != "zSonstiges" & party == "AfD") %>%
  group_by(party, thema) %>%
  summarise(n = n()) %>%
  mutate(perc = (n/sum(n))) %>%
  mutate(thema = fct_reorder(thema, perc)) %>% 
  ggplot(aes(x = thema, y = perc)) +
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "skyblue4") +
  facet_wrap(~party, labeller = label_value) +
  geom_text(aes(y = perc, 
                label = sprintf("%1.1f%%", round(100*perc, 1))),
            size = 3.1,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) +
  #ylim(0,0.22)
  theme_bw() +
  theme(text=element_text(size = 12)) +
  scale_y_continuous(labels = scales::percent_format(), limits=c(0,0.50)) +
  coord_flip()


```

## inspecting data again
```{r}
head(df_complete_clean$content, 30)

added_stopwords <- as.data.frame(c("umso", "gilt", "inwiefern", "inwieweit", "ren", "wa", "len", 
                                   "de", "nen", "lich", "jewei", "mach", "ten", "wel", "ches",
                                   "wwwprintsystemdevertrieb", "be", "re"))

colnames(added_stopwords) <- "word"
added_stopwords <- as.character(added_stopwords$word)

df_complete_clean$content %<>% 
  removeWords(added_stopwords)

View(df_complete_clean %>% 
  select(thema, title, file) %>% 
  filter(thema == "zSonstiges"))
```

## table 
```{r}
unique(df_complete_clean$thema)
df_code_book_table <- data.frame(Thema = c("Makroökonomie", "Bürgerrechte", "Gesundheit", "Agrarwirtschaft",
                                           "Arbeit & Beschäftigung", "Bildung", "Umwelt", "Energie",
                                           "Einwanderung", "Transport", "Kriminalität & Familienprobleme",
                                           "Soziale Wohlfahrt", "Gemeindeentwicklung & Wohnungsprobleme", 
                                           "Banken, Finanzen & Binnenhandel", "Verteidigung",
                                           "Technologie & Kommunikation", "Außenhandel", 
                                           "Internationale Angelegenheiten & Auslandshilfe", "Regierungsoperationen",
                                           "Öffentliche Flächen"), 
                                 Inhalt = c("Arbeitslosenquote \n allgemeine inländische Haushaltsprobleme \n Inflation, Preise und Zinsrate \n nationales Budget und Schulden \n Steuern, Steuerpolitik und Steuerreform \n Industriepolitik \n Preiskontrolle und Stabilisierung", "Ethnische Minderheiten und Gruppendiskriminierung \n Geschlecht und Diskriminierung sexuelle Diskrimination \n Altersdiskriminierung \n Diskriminierung von Behinderten \n Wahlrechte, Partizipation und damit verbundene Probleme \n Meinungsfreiheit und Religion \n Recht auf Privatsphäre und Zugang zu Informationen der Regierung \n Aktivitäten gegen die Regierung", "Umfassende Gesundheitsreformen", "bla bla", "blup blup bla", "bli blu bla", "pussy", "pussy2", "ping", "pong"))

library(xtable)
print(xtable::xtable(df_code_book_table),floating = FALSE, include.rownmaes = FALSE, tabular.environment = "longtable")
```

