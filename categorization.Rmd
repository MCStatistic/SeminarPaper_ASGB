---
title: "categorization"
author: "Marlon Schumacher"
date: "24 1 2019"
output: html_document
---

```{r}
library(pacman)
p_load(dplyr, haven, readr, ggplot2, pdftools, stringr, lubridate, RColorBrewer, tm, ggthemes)
```


```{r}
load("df_complete_clean.RData")

# removing numbers and punctuation
df_complete_clean$title %<>% 
  removeNumbers() %>% 
  removePunctuation()

# does work
head(grepl("polizei", df_complete_clean$title))

head(grepl(("polizei|sicherheit"), df_complete_clean$title))

df_complete_clean$title
  
head(df_complete_clean)

# deleting all files with no title (15 rows only)
df_complete_clean %<>% 
  filter(!is.na(title))

```

## matching with str_detect
```{r}
# matching words for each category

# topic 1
makroöko <- c("arbeitslosigkeit", "arbeitslosenquote", "zinsen","haushaltsschulden",
              "steuer","industrie") %>% 
  paste0(collapse = "|")

# topic 2
buerger <- c("diskriminierung", "minderheit", "meinungsfreiheit", "religionsfreiheit", 
             "partizipation", "wahlrecht", "gender", "gleichberechtigung", "gleichstellung",
             "gleichgeschlechtliche ehen", "öffentlichkeitsbeteiligung") %>% 
  paste0(collapse = "|")

# topic 3
gesundheit <- c("pflege", "pflegeversicherung", "krankenversicherung", "krankenkasse",
                "arzt", "krankheit","impfquote", "impfung", "alkoholkonsum", "arzneimittel",
                "gesundheitsschutz", "medizin", "patienten") %>% 
  paste0(collapse = "|")

# topic 4
agrar <- c("agrar", "landwirtschaft", "landwirte", "pflanzenschutzmittel","glyphosat") %>% 
  paste0(collapse = "|")

# topic 5
arbeit <- c("gewerkschaft", "elternzeit", "kinderbetreuung", "saisonarbeit", "arbeitsschutz", 
            "arbeitssicherheit", "mindestlohn", "mindestlöhne", "streik", "überstunden",
            "arbeitszeitgesetz", "fachkräftemangel", "arbeitszeit", "geringfügige beschäftigung",
            "befristete beschäftigung", "arbeitsbedingungen", "befristeter beschäftigung",
            "leiharbeit", "arbeit auf abruf", "arbeitsunfälle", "stellenabbau",
            "niedriglöhne") %>% 
  paste0(collapse = "|")

# topic 6
bildung <- c("studium", "lehrer", "schule", "universität", "weiterbildung",
             "geisteswissenschaften", "hochschul") %>% 
  paste0(collapse = "|")

# topic 7 
umwelt <- c("trinkwasser", "recycling", "müll", "luftverschmutzung", "plastik",
            "klimawandel", "emission", "artenschutz", "stickoxide", "wasserqualität", "umwelt",
            "klimaschutz", "insekten", "co2-speicherung", "grundwasser", "tierschutz",
            "atomtransport", "ökologisch") %>% 
  paste0(collapse = "|")

# topic 8
energie <- c("kohle", "kohleausstieg", "energie", "atomkraft", "solar", "windenergie", "erneuerbare",
             "atomstandort") %>% 
  paste0(collapse = "|")

# topic 9
einwanderung <- c("flüchtlinge", "asyl", "migration", "einwanderer", "einwanderung", 
                  "abschiebung", "integration", "familiennachzug", "schutzsuchende",
                  "fluchtursachen", "duldung", "zuwanderung") %>% 
  paste0(collapse = "|")

# topic 10
transport <- c("autobahn", "schienenverkehr", "bahn", "flughafen", "lkw", "maut", "mobilität", 
               "schienen", "zugverspätung", "verkehrswende", "verkehrsprojekt", "radverkehr",
               "verkehrspolitik", "straßenbrücke", "verkehrsminister") %>% 
  paste0(collapse = "|")

# topic 11
krimi <- c("rauschmittel", "steuerhinterziehung", "bnd", "bundesnachrichtendienst", 
           "gefängnis", "kindesmissbrauch", "kinderpornografie", "interpol", 
           "kindesentführung", "straftaten", "kriminalität", "sicherungsverwahrung",
           "tötungsdelikte", "haftbefehl", "bundeskriminalamt", "polizei", "gewalttaten",
           "linksextrem", "rechtsextrem", "ermittlungsverfahren", "gefährder") %>% 
  paste0(collapse = "|")

# topic 12
sozi <- c("arbeitslosengeld", "renten", "altersarmut", "pension", "armut", "tafel", "kindergeld",
          "jobcenter", "sgb-ii", " rente ", "vermögensungleichheit", "einkommensungleichheit",
          "riester-rente", "sozialgesetzbuch", "altersvorsorge") %>% 
  paste0(collapse = "|")

# topic 13
wohn <- c("mietpreis", "miete", "wohnung", "obdachlos", "wohnhilfe", "wohnheim",
          "brachfläche", "wohnen") %>% 
  paste0(collapse = "|")

# topic 14
banken <- c("bank", "kartell", "finanzsektor", "verbraucherschutz", "tourismus", "patent", "urheberrecht",
            "verbraucherschutz", "verbraucherrecht", "fluthilfe", "wettbewerbsbeschränkung", "katastrophenschutz",
            "finanzmarkt", "kapitalmarkt") %>% 
  paste0(collapse = "|")

# topic 15
verteidigung <- c("bundeswehr", "kriegseinsatz", "kriegseinsätze", "nato") %>% 
  paste0(collapse = "|")

# topic 16
tech_kom <- c("internet", "breitband", "telekommunikation", "gez", "rundfunk", "twitter", "facebook",
              "digitalisierung", "raumfahrt", "cybersicherheit") %>% 
  paste0(collapse = "|")

# topic 17
außenh <- c("handelsabkommen", "export", "import", "zölle", "einfuhrbeschränkung", 
            "einfuhr", "steueroasen", "freihandel", "außenhandel", "export", "waffenexport",
            "ceta", "ttip", "transatlantic trade") %>% 
  paste0(collapse = "|")

# topic 18
int_aus <- c("auslandshilfe", "entwicklungsländer", "menschenrecht", "humanitäre hilfe", "brexit",
             "arbeitsbedingungen in schwellen und entwicklu", "islamischer staat", "terror",
             "bürgerkrieg") %>% 
  paste0(collapse = "|")

regierung <- c(" sanktionen ", "bürokratieentlastung", "bürokratieabbau", 
               "bundesanstalt für immobilienaufgaben", "deutsch-georgische", "deutsch-türkischen",
               "deutsch-indischen", "deutsch-montenegrinische", "deutsch-russische",
               "deutsch-armenische", "deutsch-ukrainische", "deutschland und aserbaidschan",
               "diplomat") %>% 
  paste0(collapse = "|")

# public goods muss raus, da es hierzu nahezu keinerlei Themen gibt
public_goods <- c("denkmal", "denkmäler") %>% 
  paste0(collapse = "|")

df_complete_clean %<>% 
  mutate(thema = case_when(
    str_detect(title, makroöko) ~ "Makroökonomie", #1
    str_detect(title, buerger) ~ "Bürgerrechte",#2
    str_detect(title, gesundheit) ~ "Gesundheit", #3
    str_detect(title, agrar) ~ "Agrarwirtschaft", #4
    str_detect(title, arbeit) ~ "Arbeit & Beschäftigung", #5
    str_detect(title, bildung) ~ "Bildung", #6
    str_detect(title, umwelt) ~ "Umwelt", #7
    str_detect(title, energie) ~ "Energie", #8
    str_detect(title, einwanderung) ~ "Einwanderung", #9
    str_detect(title, transport) ~ "Transport", #10
    str_detect(title, krimi) ~ "Kriminalität & Familienprobleme", #11
    str_detect(title, sozi) ~ "Soziale Wohlfahrt", #12
    str_detect(title, wohn) ~ "Gemeindeentwicklung & Wohnungsprobleme", #13
    str_detect(title, banken) ~ "Banken, Finanzen & Binnenhandel", #14
    str_detect(title, verteidigung) ~ "Verteidigung", #15
    str_detect(title, tech_kom) ~ "Technologie & Kommunikation", #16
    str_detect(title, außenh) ~ "Außenhandel", #17
    str_detect(title, int_aus) ~ "Internationale Angelegenheiten & Auslandshilfe", #18
    str_detect(title, regierung) ~ "Regierungsoperationen", #19
    # str_detect(title, public_goods) ~ "Öffentliche Flächen", #20
    TRUE ~ "zSonstiges"
  ))

df_complete_clean %>% 
  sjmisc::frq(thema) %>% 
  kableExtra::kable()

df_complete_clean %>% 
  filter(str_detect(title, "diplomat") == TRUE)


View(df_complete_clean %>% 
       select(title, thema, file) %>% 
       filter(thema == "zSonstiges"))
```

## checking categories if the fitting is good
```{r}
# looks very good
View(df_complete_clean %>% 
  select(title, thema) %>% 
  filter(thema == "Soziale Wohlfahrt"))

View(df_complete_clean %>% 
  select(title, thema) %>% 
  filter(thema == "Gemeindeentwicklung & Wohnungsprobleme"))

View(df_complete_clean %>% 
  select(title, thema) %>% 
  filter(thema == "Transport"))
```

## checking overlapping
```{r}
df_overlap <- df_complete_clean %>% 
  mutate(makroökonomie = case_when(str_detect(title, makroöko) ~ 1, TRUE ~ 0)) %>% 
  mutate(buerger = case_when(str_detect(title, buerger) ~ 1, TRUE ~ 0)) %>% 
  mutate(gesundheit = case_when(str_detect(title, gesundheit) ~ 1, TRUE ~ 0)) %>% 
  mutate(agrar = case_when(str_detect(title, agrar) ~ 1, TRUE ~ 0)) %>% 
  mutate(arbeit = case_when(str_detect(title, arbeit) ~ 1, TRUE ~ 0)) %>% 
  mutate(bildung = case_when(str_detect(title, bildung) ~ 1, TRUE ~ 0)) %>% 
  mutate(umwelt = case_when(str_detect(title, umwelt) ~ 1, TRUE ~ 0)) %>% 
  mutate(energie = case_when(str_detect(title, energie) ~ 1, TRUE ~ 0)) %>% 
  mutate(einwanderung = case_when(str_detect(title, einwanderung) ~ 1, TRUE ~ 0)) %>% 
  mutate(transport = case_when(str_detect(title, transport) ~ 1, TRUE ~ 0)) %>% 
  mutate(krimi = case_when(str_detect(title, krimi) ~ 1, TRUE ~ 0)) %>% 
  mutate(sozi = case_when(str_detect(title, sozi) ~ 1, TRUE ~ 0)) %>% 
  mutate(wohn = case_when(str_detect(title, wohn) ~ 1, TRUE ~ 0)) %>% 
  mutate(banken = case_when(str_detect(title, banken) ~ 1, TRUE ~ 0)) %>% 
  mutate(verteidigung = case_when(str_detect(title, verteidigung) ~ 1, TRUE ~ 0)) %>% 
  mutate(tech_kom = case_when(str_detect(title, tech_kom) ~ 1, TRUE ~ 0)) %>% 
  mutate(außenh = case_when(str_detect(title, außenh) ~ 1, TRUE ~ 0)) %>% 
  mutate(int_aus = case_when(str_detect(title, int_aus) ~ 1, TRUE ~ 0)) %>%
  mutate(regierung = case_when(str_detect(title, regierung) ~ 1, TRUE ~ 0)) %>% 
  mutate(public_good = case_when(str_detect(title, public_goods) ~ 1, TRUE ~ 0)) %>% 
  mutate(overlap = makroökonomie + buerger + gesundheit + agrar +
                       arbeit + bildung + umwelt + energie + einwanderung +
                       transport + krimi + sozi + wohn + banken + verteidigung +
                       tech_kom + außenh + int_aus + regierung + public_good)


df_overlap %>% 
  filter(overlap != 0) %>% 
  sjmisc::frq(overlap)

View(df_overlap %>%
  select(overlap, title, thema, file) %>% 
  filter(overlap == 2))

View(df_overlap %>%
  filter(overlap == 4))

```

# Falsches Matching korrigieren
```{r}
# für alle matches mit 3 overlaps
View(df_overlap %>%
       select(overlap, title, thema, file) %>%
       filter(overlap == 3))

df_complete_clean %>% 
  mutate(thema = case_when(
    # wenn file == xy, dann soll x-thema zugewiesen werden
    file == "1900907" ~ "Internationale Angelegenheiten & Auslandshilfe", # terror
    file == "1903371" ~ "Außenhandel", # Waffenexporte
    file == "1902085" ~ "zSonstiges", # viel zu unspezifisch!
    file == "1800584" ~ "Außenhandel", # Handelsabkommen...
    file == "1808522" ~ "Internationale Angelegenheiten & Auslandshilfe", # steueroasen (int. Finanzm.)
    file == "1811759" ~ "Internationale Angelegenheiten & Auslandshilfe", # terror
    file == "1813162" ~ "Außenhandel", # handelsabkommen
    TRUE ~ thema)) # alle restlichen anfragen erhalten die bereits zugeordnete themen

right_matches_3 <- c("1800521")

# alle anfragen mit overlap von 2
View(df_overlap %>%
  select(overlap, title, thema, file) %>% 
  filter(overlap == 2))

df_complete_clean %>% 
  mutate(thema = case_when(
    # wenn file == xy, dann soll x-thema zugewiesen werden
    file == "xxxx" ~ "xxxx", 
    file == "whfwh" ~ "real topic",
    file == "xx" ~ "real topic",
    TRUE ~ thema)) # alle restlichen anfragen erhalten die bereits zugeordnete themen
  
# richtige Matches, jedoch dennoch vorhandener overlap
right_matches_2 <- c("file1", "file2", "file3")

```

# little inspection
```{r}
plot_18_pre <- df_complete_clean %>%
  filter(thema != "zSonstiges" & bt == "18") %>%
  group_by(thema) %>%
  summarise(n = n()) %>%
  mutate(perc = (n/sum(n))*100) %>%
  ggplot(aes(x = reorder(thema, +perc), y = perc)) +
  geom_bar(position = "dodge", 
           stat = "identity",
           fill = "skyblue4") +
  geom_text(aes(y = perc, 
                label = round(perc, 1)),
            size = 3.1,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) +
  theme_bw() +
  ggtitle("") +
  ylab("percentage") +
  xlab("") +
  coord_flip()

plot_19_pre <- df_complete_clean %>%
  filter(thema != "zSonstiges" & bt == "19") %>%
  group_by(thema) %>%
  summarise(n = n()) %>%
  mutate(perc = (n/sum(n))*100) %>%
  ggplot(aes(x = reorder(thema, +perc), y = perc)) +
  geom_bar(position = "dodge", 
           stat = "identity",
           fill = "skyblue4") +
  geom_text(aes(y = perc, 
                label = round(perc, 1)),
            size = 3.1,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1)+
  theme_bw() +
  ggtitle("") +
  ylab("percentage") +
  xlab("") +
  coord_flip()

library(ggpubr)
figure_1 <- ggarrange(plot_18_pre, plot_19_pre,
          labels = c("18. Bundestag", "19. Bundestag"),
          ncol = 1, nrow = 2)
ggsave("figure_1.png", figure_1, width = 10, height = 8)
```